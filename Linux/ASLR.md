# ASLR

作者：嵌入式软件:pen:

## 1.什么是ASLR：

- **ASLR**—Address Space Layout Randomization，即**地址空间随机化**。
  - **ASLR**在2005年被引入到Linux的内核**kernel 2.6.12**中，随着内存地址的随机化，使得响应的应用变得随机，同一应用多次执行所使用内存空间完全不同。
  - **目的**：
    - 用来防止黑客通过堆栈缓冲区溢出攻击计算机。
- 内存虚拟化：
  - 操作系统拥有内存虚拟化的功能，即每个进程都有独立的、不被干涉的内存空间(虚拟内存空间)。
  - 对于同一个可执行程序，如果同时使用两个**进程**去执行的话，那么这两个进程的内存分配是完全一致的，因为所反映出的内存分配都是基于虚拟内存的内存分配。

## 2.如何设置ASLR：

- 在**Ubuntu22.04**中，可以通过更改`proc/sys/kernel/randomize_va_space`文件的值达到设置**ASLR**的目的。
  - 当然，对于所有的**Linux内核**都是一样的。
  - 需要切换到**root**用户，并且使用**echo**命令。
  - 不能使用编辑器更改的原因：
    - 修改了**ASLR**也会影响编辑器地址分配。
- **ASLR**有三种配置选项：
  - 0：关闭ASLR，即不开启地址空间随机化。
  - 1：半随机，共享库、栈、mmap以及VDSO上的内存地址被随机化。
  - 2：全随机，共享库、栈、mmap、VDSO以及heap上的内存地址被随机化。

## 3.测试ASLR：

- 测试用例：

  - ```c
    /*在heap上分配内存，并且打印出内存的地址*/
    /*我们如果想测试虚拟内存，肯定希望运行该程序的不同进程所打印的地址是相同的*/
    #include <stdio.h>
    #include <stdlib.h>
    
    int main(int argc, char *argv[])
    {
        int *p = malloc(sizeof(int));
        *p = 0;
        printf("%p\n", p);
    }
    ```

  - 将该源文件编译成`mem`可执行文件。

  - 首先开启ASLR的**全随机测试**：

    - ```shell
      ./mem & ./mem &
      ```

    - ```shell
      [1] 17424
      [2] 17425
      0x5559141322a0
      0x5555b70a12a0
      [1]-  Done                    ./mem
      [2]+  Done                    ./mem
      ```

    - 很显然，虽然操作系统将内存虚拟化，但是由于**ASLR**的存在，打印出来的地址并不相同。

  - 关闭ASLR：

    - ```shell
      ./mem & ./mem &
      ```

    - ```c
      [1] 19094
      [2] 19095
      0x5555555592a0
      0x5555555592a0
      [1]-  Done                    ./mem
      [2]+  Done                    ./mem
      ```

    - 很显然，两个进程在堆上分配的内存地址是相同的，这也证实了操作系统支持内存虚拟化。