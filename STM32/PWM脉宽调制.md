# PWM脉宽调制

作者：嵌入式软件小组:pen:

## 1.什么是PWM？

#### 1.1 wikipedia：

- **PWM**简称**脉宽调制**，是用**脉冲**来输出**模拟信号**的一种技术。
  - **PWM**是一种**技术**:ok:，而不是一种**信号**。
  - **PWM**通过对一系列脉冲的**宽度**进行调制，来等效地获得所需要**波形**(含**形状**和**幅值**)。
    - 对于同一个正弦波，其**电压**是固定不变的。
  - 对于数字电路来讲，输出的电压只有两种：$U_{ON}$和$U_{OFF}$
    - 使用**PWM**技术可以等效获得处于$U_{ON}$和$U_{OFF}$之间的任意波形，即**任意电压**。
    - **任意电压**：
      - 在不改变最大电压的情况下，通过改变**最大电压出现的频率**，来改变整体的**平均电压**。
  - **电压**可以直接控制家用电器设备中的音量、LED灯的亮度等，因此可以直接使用**模拟电路**来完成。
    - 但模拟电路存在**难以调节**、**功耗大**、**易受噪声和环境干扰**等问题，因此使用**数字电路**+**PWM技术**等效调节电压。

#### 1.2  控制PWM的重要参数：

- **Frequency 频率**:tiger:：
  - 频率是周期的**相反数**，单位是**Hz**。
    - 这里的周期表示**脉冲周期**：从高电平的**起始位置**到下一次高电平的**起始位置**所花的**时间**。
    - 频率和周期的**换算**：
      - **1s        <--->     1Hz**
      - **1ms    <--->    1KHz**
      - **1us     <--->    1MHz**
      - **1ns     <--->    1GHz**
  - 选择**PWM的频率**需要综合考虑应用的需求和硬件的能力。
    - 较高的频率通常可以提供更精确的控制，但也可能导致更多的开关损耗。
    - 较低的频率可以降低开关损耗，但在某些应用中可能引入可听到的噪音。
    - **电机设备的运行特性**：
      - 较高频率的**PWM**可以提供更**平滑**的电机运动，但也会引入更多的电流谐波和损耗。
    - **LED灯的亮度控制**：
      - 较高频率的**PWM**可以提供更精确的亮度控制，同时减小了**可见闪烁**。
        - 欺骗人眼:eye:。

- **Duty Cycle 占空比**:lion:：
  - 这个参数是**PWM**技术中最重要的参数，占空比表示一个**脉冲周期**内，**高电平的时间**与整个周期时间的比例。
  - 占空比用来改变**脉冲周期**的**平均电压**。
    - ![1920px-Duty_cycle_general.svg](https://nickaljy-pictures.oss-cn-hangzhou.aliyuncs.com/1920px-Duty_cycle_general.svg.png)
    - 如果我们考虑一个周期为$T$的脉冲波$f(t)$ ，低值$y_{min}$，高值为$y_{max}$，跟一个占空比$D$，此波的**平均值**为：
      - ![9eaf9734459b6422b6a50977da6236ae7622ef3d](https://nickaljy-pictures.oss-cn-hangzhou.aliyuncs.com/9eaf9734459b6422b6a50977da6236ae7622ef3d.svg)
      - **展开**：
      - ![3ff6bfb695bad62cb26a2f8c5fa2d565431e5375](https://nickaljy-pictures.oss-cn-hangzhou.aliyuncs.com/3ff6bfb695bad62cb26a2f8c5fa2d565431e5375.svg)
      - 通常，$y_{min} = 0$，$y_{max} = 3.3/5v$，因此**平均值**仅和**占空比**有关。
- 在使用**PWM**技术的时候，首先确定`Frequency`，其次确定`Duty cycle`。

#### 1.3 PWM的实际应用：

- **呼吸灯**:b:：
  - **频率**：
    - 如果频率很小的话，人眼能够很明显的看到**闪烁**，当频率大于**50Hz**(脉冲周期**T < 20ms**)的时候，人眼就会产生**视觉暂留**，即认为**LED灯常亮**。
  - **占空比**：
    - 在**一定的频率**下，改变**占空比**，改变**LED灯**的亮度，占空比越大，**LED灯**越亮。

![giphy](https://nickaljy-pictures.oss-cn-hangzhou.aliyuncs.com/giphy.gif)

- **舵机控制**:m:：
  - 以**180°**转动的**伺服舵机SG90**为例：
    - ![v2-26c7f03ba98dfbd6cd557a35943cb581_1440w](https://nickaljy-pictures.oss-cn-hangzhou.aliyuncs.com/v2-26c7f03ba98dfbd6cd557a35943cb581_1440w.png)
  - **频率**：
    - 频率越高，舵机转动越平滑，通常情况下，舵机的频率为**50Hz**，即脉冲周期为**20ms**。
  - **占空比**：
    - 控制舵机的**转角**。
    - 控制关系(**高电平时间—转角**)：
      - **0.5ms   <--->   0度**
      - **1.0ms   <--->   45度**
      - **1.5ms   <--->   90度**
      - **2.0ms   <--->   135度**
      - **2.5ms   <--->   180度**

![在这里插入图片描述](https://nickaljy-pictures.oss-cn-hangzhou.aliyuncs.com/20200128155221315.gif)

- **电机控制**:car:：
  - **频率**：
    - 频率越高，舵机转动越平滑。
  - **占空比**：
    - 占空比越大，电机的转速越快。

![img](https://nickaljy-pictures.oss-cn-hangzhou.aliyuncs.com/m3508-01.76b56e4.jpg)

## 2.STM32中使用PWM：

#### 2.1 定时器与PWM：

- 在**STM32**中，使用**PWM**技术要利用**Timer**，通过**Timer**来产生频率一定，占空比不同的输出信号。

