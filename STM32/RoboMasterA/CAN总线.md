# CAN总线

### 1.CAN介绍：

#### 1.1 什么是CAN：

- **CAN(Controller Area Network)**，即**控制器局域网**，是**ISO国际**标准化的**串行通信协议**，**CAN总线**目前作为**车载总线**标准。
  - **罗伯特·博士**公司在**1983年**开发了**控制器局域网**，即**CAN总线**。
  - 第一个**CAN控制芯片**由**英特尔**和**飞利浦**生产，并于**1987年**发布。
  - 第一台装载基于**CAN**的多重系统汽车是**梅赛德斯-奔驰W140**，也就是"**虎头奔**":tiger:。
  - **CAN总线**通信方式：**异步串行通信**。
- **低速CAN**：
  - **ISO标准**：**ISO111519**
  - **通信速率**：**10Kbps ~ 125Kbps**
  - **总线长度**：**1000m**
- **高速CAN**：
  - **ISO标准**：**ISO11898**
  - **通信速率**：**125Kbps ~ 1Mbps**
  - **总线长度**：**40m**
- **CAN总线拓扑图**：
  - **低速CAN**：
    - ![image-20231030115626296](https://nickaljy-pictures.oss-cn-hangzhou.aliyuncs.com/image-20231030115626296.png)
  - **高速CAN**：
    - ![image-20231030144455484](https://nickaljy-pictures.oss-cn-hangzhou.aliyuncs.com/image-20231030144455484.png)
  - **CAN节点的结构**：
    - 通常来讲，一个**CAN节点**包含三个部分：
      - **中央处理器(CPU)**：
        - 作为**中央处理单元**，将**CAN控制器**作为**外设**处理(对**CAN控制器**中的消息进行处理)。
      - **CAN控制器**：
        -  通常是**集成单片机**中的一部分，例如**STM32**中的**CAN控制器**。
        - **接收消息**：
          - **CAN控制器**从**CAN收发器**中获取消息，通常获取消息之后**CAN控制器**会产生**中断**，进而**处理器**可以获取这个消息。
        - **发送消息**：
          - **处理器**将待发送的消息传递到**CAN控制器**中，**总线空闲**的时候，**CAN控制器**将消息发送到**CAN收发器**中。
      - **CAN收发器**：
        - 将**数据流**在**CAN总线层标准**和**CAN控制层标准**之间转换。
        - **CAN接收器**作为**CAN控制器**和**CAN总线**之间的**中介点**，通常来讲，不会集成在单片机芯片中，需要使用额外的**CAN收发器芯片**。
    - **STM32**中集成有**CAN控制器**和**CAN接收器**，并且集成了**CAN总线**，以**C620电调**为例，电调连接到**STM32**的**CAN接口**上，就相当于连接到**STM32**中集成的**CAN总线**上，此时**C620电调**作为**CAN总线**上的一个**节点**。
    - **CAN总线**是**多主控制结构**，每个节点都可以**主动**发送数据。
- **CAN收发器芯片**：
  - ![image-20231030160641463](https://nickaljy-pictures.oss-cn-hangzhou.aliyuncs.com/image-20231030160641463.png)
  - 对于**RoboMaster-A**来讲，**STM32F427IIH6**中集成两路**CAN总线**，这里展示的是**CAN2**，使用的**CAN收发器芯片**是**MCP2562-E/MF**：
    - ![image-20231030161106542](https://nickaljy-pictures.oss-cn-hangzhou.aliyuncs.com/image-20231030161106542.png)
    - ![image-20231030161053532](https://nickaljy-pictures.oss-cn-hangzhou.aliyuncs.com/image-20231030161053532.png)
  - **MCP2562-E/MF**最大传输速度可达**1Mbps**，芯片的输入电压是**5V**，该电路对**5V**的电源进行**滤波**。
  - 同时，芯片的**CAN_H**和**CAN_L**引脚之间**并联**一个**120Ω**电阻，形成**闭环回路**。
    - 在**CAN_H**和**CAN_L**上外接**ESD二极管**，**防止静电**。

#### 1.2 CAN的物理层：

- **CAN协议**使用**差分信号**进行**数据传输**，根据**CAN_H**和**CAN_L**上的**电位差**来判断**总线电平**。
  - 总线电平分为**显性电平(逻辑0)**和**隐性电平(逻辑1)** ，二者必居其一。
  - **显性电平**具有**优先权**。
- **高速CAN的物理信号**：
  - <img src="https://nickaljy-pictures.oss-cn-hangzhou.aliyuncs.com/image-20231030152330813.png" alt="image-20231030152330813" style="zoom:80%;" />
  - ![image-20231030153114451](https://nickaljy-pictures.oss-cn-hangzhou.aliyuncs.com/image-20231030153114451.png)
  - **隐性电平**：
    - 标准情况：**CAN_H**的电压值是**2.5V**，**CAN_L**的电压值是**2.5V**，**电位差**是**0V**，此时表示**隐性电平(逻辑1)**。
  - **显性电平**：
    - 标准情况：**CAN_H**的电压值是**3.5V**，**CAN_L**的电压值是**1.5V**，**电位差**是**2V**，此时表示**显性电平(逻辑0)**。
- **低速CAN的物理信号**：
  - <img src="https://nickaljy-pictures.oss-cn-hangzhou.aliyuncs.com/image-20231030155139790.png" alt="image-20231030155139790" style="zoom:80%;" />
  - ![image-20231030155219453](https://nickaljy-pictures.oss-cn-hangzhou.aliyuncs.com/image-20231030155219453.png)
  - **隐性电平**：
    - 标准情况：**CAN_H**的电平是**1.5V**，**CAN_L**的电平是**3.25V**，**电位差**是**-1.5V**，此时表示**隐性电平(逻辑1)**。
  - **显性电平**：
    - 标准情况：**CAN_H**的电平是**4.0V**，**CAN_L**的电平是**1.0V**，**电位差**是**3.0V**，此时表示**显性电平(逻辑0)**。

#### 1.3 CAN的数据链路层(协议层)：

- **CAN协议**以**"帧"**的形式进行通信，**CAN协议**定义了**5种**类型的**帧**：

  - **数据帧**：**Data Frame**，发送节点向接收节点**传输数据**的帧。
  - **遥控帧**：**Remote Frame**，接收节点向具有**相同ID**的发送节点**请求数据**的帧。
  - **错误帧**：**Error Frame**，接收节点**检测出错误**时向其他节点**通知**的帧。
  - **过载帧**：**Overload Frame**，接收节点**尚未做好接收准备**时向其他节点**通知**的帧。
  - **间隔帧**：**Inter Frame Space**，用于将**数据帧/遥控帧**与前面的帧**间隔**开。

  - 其中，**数据帧**和**遥控帧**是**最常用**的两个帧。
- **数据帧的组成**：
  - **数据帧**由**7段**组成，**数据帧**又分为**标准数据帧**和**扩展数据帧**，**标准数据帧**由**CAN2.0A**规定，**扩展数据帧**由**CAN2.0B**规定。
    - 两者只在**仲裁段**和**控制段**有区别。
  - **标准数据帧格式**：
    - ![image-20231031140325474](https://nickaljy-pictures.oss-cn-hangzhou.aliyuncs.com/image-20231031140325474.png)
    - **帧起始**：
      - 表示数据帧**开始**的段，**1位显性信号(逻辑0)**表示。
    - **仲裁段**：
      - 表示数据帧的**优先级**。
    - **控制段**：
      - 表示**数据段**的**字节数**。
    - **数据段**：
      - **数据帧**中发送的数据内容，一帧可发送**0 ~ 8字节**数据。
    - **CRC段**：
      - 检查**数据帧**传输是否有错误，采用**CRC校验**，其中**DEL域**作为**界定符**。
    - **ACK段**：
      - 检查**数据帧**是否正常接收。
    - **帧结束**：
      - 表示数据帧**结束**的段，**7位隐形信号(逻辑1)**表示。
  - **扩展数据帧格式**：
    - ![image-20231031145147724](https://nickaljy-pictures.oss-cn-hangzhou.aliyuncs.com/image-20231031145147724.png)
    - **帧起始**：
      - 表示数据帧**开始**的段，**1位显性信号(逻辑0)**表示。
    - **仲裁段**：
      - 表示数据帧的**优先级**。
      - 注意：表示**ID**的位一共有**29位**。
    - **控制段**：
      - 表示**数据段**的**字节数**。
    - **数据段**：
      - **数据帧**中发送的数据内容，一帧可发送**0 ~ 8字节**数据。
    - **CRC段**：
      - 检查**数据帧**传输是否有错误，采用**CRC校验**，其中**DEL域**作为**界定符**。
    - **ACK段**：
      - 检查**数据帧**是否正常接收。
    - **帧结束**：
      - 表示数据帧**结束**的段，**7位隐形信号(逻辑1)**表示。

#### 1.4 CAN总线数据同步：

- **CAN总线**采用**异步串行通信**，为了实现对总线电平信号的**正确采样**，避免时钟频率误差、传输相位偏差等问题，**CAN节点**需要对总线进行**数据同步**。
- **CAN节点**通过"**位同步**"**正确采样**：
  - **位同步**是数据同步的基础，**位同步**定义了**CAN**对**1bit数据**的接收时序：
    - 在**CAN总线**中，**1bit**由**4段**构成：**同步段(SS)**、**传播时间段(PTS)**、**相位缓冲段1(PBS1)**、**相位缓冲段2(PBS2)**，每一段都由**Time Quantum(时间片)**构成。
    - ![image-20231031153937898](https://nickaljy-pictures.oss-cn-hangzhou.aliyuncs.com/image-20231031153937898.png)
  - **采样点**总是在**PBS2段**的**起始处**。
    - "**采样**"指读取**CAN总线**上的电平，并且将读取到的电平作为**当前bit**的值，无论检测到的是**显性电平**还是**隐性电平**，只要总线上的**信号跳变**出现在**SS段**范围内，就说明该**CAN节点**与**CAN总线**的**时序同步**。
- **数据同步**分为**硬件同步**和**再同步**：
  - **硬件同步**：
    - **CAN总线**上的节点在**接收总线数据**的时候，通过检测**帧起始信号(1bit)**是否在**CAN节点**中位数据的**SS段**内，进而判断**节点内部时序**和**总线**是否同步。
      - 如果**帧起始信号(1bit)**不在**SS段**内，说明**CAN节点内部时序**和**CAN总线时序**同步，能够获取**正确的电平状态**。
    - 如果检测到不同步，即**帧起始信号**不在**SS段**内，此时**CAN节点**会使用**硬件同步方式**进行调整，即把**CAN节点**自身的**SS段**平移到**帧起始信号的跳变沿**处，此时即将**节点内部时序**和**总线时序**同步。
    - ![image-20231031170805546](https://nickaljy-pictures.oss-cn-hangzhou.aliyuncs.com/image-20231031170805546.png)
  - **再同步**：
    - 