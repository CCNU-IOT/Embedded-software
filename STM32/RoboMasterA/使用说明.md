# 使用说明

### 1.开发板介绍：

- **机甲大师开发板A**:facepunch:：
  - ![image-20231027163215766](C:\Users\nickaljy\AppData\Roaming\Typora\typora-user-images\image-20231027163215766.png)

- **开发板简介(吹嘘:green_salad:**)：
  - **RoboMaster开发板A**是面向**机器人DIY**的开源**主控板**。
    - 主控芯片：**STM32F427IIH6**
    - 板载**IMU**传感器
    - 具有丰富的**扩展接口**和**通信接口**
    - 具有**防反接**和**缓启动**等多重保护
    - 主控板可配合**M3508直流无刷减速电机**、**M2006直流无刷减速电机**、**UWB定位模块**等
    - 开发板输入电压：**24V(最大电压26V)**
      - 输入接口：**XT30接口**
      - 推荐使用**直流稳压电源**或**4~6s LiPo**

### 2.开发板接口介绍：

- ![image-20231027164100018](https://nickaljy-pictures.oss-cn-hangzhou.aliyuncs.com/image-20231027164100018.png)
- 拿到这个板子，你会发现怎么这么多接口**啊啊啊啊啊啊**(主控板是这样的)，你也可以叫"**接口板**"。

#### 2.1 **CAN接口**：

- ![image-20231027165123658](https://nickaljy-pictures.oss-cn-hangzhou.aliyuncs.com/image-20231027165123658.png)

#### 2.2 **可控电源输出接口**：

- ![image-20231027165533585](https://nickaljy-pictures.oss-cn-hangzhou.aliyuncs.com/image-20231027165533585.png)
- **可控电源：可以开启/关闭**
  - 上述所有的可控电源输出电压**24V**，四路总电流不能超过**20A**，单路电流不能超过**10A**。
  - ![image-20231027170638695](https://nickaljy-pictures.oss-cn-hangzhou.aliyuncs.com/image-20231027170638695.png)
  - 上图为一路可控电源的原理图，通过一个**NPN晶体管**和一个**PMOS**组成，**GPIOH4**引脚控制**VCC_OUT3**。
    - 当**PH4**输出**高电平**的时候，晶体管工作在**放大区**，**VCC_OUT3**输出**24V**电压。
    - 当**PH4**输出**低电平**的时候，晶体管工作在**截止区**，**VCC_OYT3**不输出。

#### 2.3 **PWM接口**：

- ![image-20231027211624424](C:\Users\nickaljy\AppData\Roaming\Typora\typora-user-images\image-20231027211624424.png)

- **板标**对应**STM32接口**：

  - **上部分8路PWM接口**：
    - **H   ——   TIM4_CH1(PD 12)**
    - **G   ——   TIM4_CH2(PD 13)**
    - **F   ——   TIM4_CH3(PD 14)**
    - **E   ——   TIM4_CH4(PD 15)**
    - **D   ——   TIM5_CH1(PH 10)**
    - **C   ——   TIM5_CH2(PH 11)**
    - **B   ——   TIM5_CH3(PH 12)**
    - **A   ——   TIM5_CH4(PI 0)**

  - **下部分8路PWM接口**：
    - **S    ——    TIM2_CH1(PA 0)**
    - **T    ——    TIM2_CH2(PA 1)**
    - **U    ——   TIM2_CH3(PA 2)**
    - **V    ——    TIM2_CH4(PA 3)**
    - **W    ——    TIM8_CH1(PI 5)**
    - **X    ——    TIM8_CH2(PI 6)**
    - **Y    ——    TIM8_CH3(PI 7)**
    - **Z    ——    TIM8_CH4(PI 8)**
  - **板标23用于内部PWM**

#### 2.4 **LED灯：**

- ![image-20231027174649297](https://nickaljy-pictures.oss-cn-hangzhou.aliyuncs.com/image-20231027174649297.png)
- **板标10**：
  - **8**个自定义**LED灯**。
  - **PG1 ~PG8**外接**LED灯**，**LED共阳极**，输出**低电平点亮**，**高电平熄灭**。
- **板标18**：
  - **2**个自定义**LED灯**。
  - **PF14、PE11**外接**LED灯**，**LED共阳极**，输出**低电平点亮，高电平熄灭**。
- **板标21**：
  - **2**个**12V**电源接口**指示灯**。
- ![image-20231028124511362](https://nickaljy-pictures.oss-cn-hangzhou.aliyuncs.com/image-20231028124511362.png)
  - **LED灯**的点亮电流约为**4mA**，因此在回路中串联一个**1K**的**电阻**(**封装0201**)，串联**电阻**防止电流过大烧毁**LED灯**。
  - 在回路中外接**小容量电容**(**电容要接地**)，过滤电源的**高频噪声**。

#### 2.5 **OLED接口**：

- ![image-20231027211329428](https://nickaljy-pictures.oss-cn-hangzhou.aliyuncs.com/image-20231027211329428.png)
- **OLED**的传输协议应该是**IIC**的协议。
- ![image-20231029122345845](https://nickaljy-pictures.oss-cn-hangzhou.aliyuncs.com/image-20231029122345845.png)
- 每一个IO口都串联**120/600Ω磁珠**，用来保护单片机，并且外接**ESD二极管**，**防静电**。

#### 2.6 **USB接口**：

- ![image-20231027214341719](https://nickaljy-pictures.oss-cn-hangzhou.aliyuncs.com/image-20231027214341719.png)
- 全速**USB**端口，支持**USB2.0**标准。
- ![image-20231029122109359](https://nickaljy-pictures.oss-cn-hangzhou.aliyuncs.com/image-20231029122109359.png)

#### 2.7 **SWD接口：**

- ![image-20231027214559145](https://nickaljy-pictures.oss-cn-hangzhou.aliyuncs.com/image-20231027214559145.png)
- 开发板的下载接口，支持**SWD协议**，将**SWD接口**与**J-Link**的对应引脚相连即可下载。
- ![image-20231028121331705](https://nickaljy-pictures.oss-cn-hangzhou.aliyuncs.com/image-20231028121331705.png)
  - <img src="https://nickaljy-pictures.oss-cn-hangzhou.aliyuncs.com/53261-0871.jpg" alt="53261-0871" style="zoom:33%;" />
    - 上图为**8P**的卧式**53261接口**。
  - **SWDIO**和**SWCLK**串联**100Ω**的**电阻**，**VCC_3V3**串联一个**60Ω/120Ω**的**磁珠**，起到保护单片机的作用。
    - 电阻是**0201**的封装，磁珠是**0402**的封装。

#### 2.8.1 **通用UART接口**：

- 两个开发板进行**UART**通信的时候，需要**"共地"**。
- ![image-20231027220754890](https://nickaljy-pictures.oss-cn-hangzhou.aliyuncs.com/image-20231027220754890.png)


#### 2.8.2 **SDK UART接口**：

- ![image-20231027220911175](https://nickaljy-pictures.oss-cn-hangzhou.aliyuncs.com/image-20231027220911175.png)
- ![image-20231029114713591](https://nickaljy-pictures.oss-cn-hangzhou.aliyuncs.com/image-20231029114713591.png)
  - **TX**和**RX**均串联一个**120/600Ω**的磁珠，额定电流**150mA**，用来保护单片机。
  - **TX**和**RX**回路中各外接一个**ESD二极管**和**47pF电容**，其中**ESD二极管**用来**防静电**。
  - **SDK-UART接口**采用**11257W00-4P-S**封装：
    - <img src="https://nickaljy-pictures.oss-cn-hangzhou.aliyuncs.com/11257W00-4P-S-R03.jpg" alt="11257W00-4P-S-R03" style="zoom:33%;" />

#### 2.8.3 **蓝牙UART**：

- ![image-20231027220955466](https://nickaljy-pictures.oss-cn-hangzhou.aliyuncs.com/image-20231027220955466.png)
- ![image-20231029122226135](https://nickaljy-pictures.oss-cn-hangzhou.aliyuncs.com/image-20231029122226135.png)
  - 对外接口是普通的**4P排针**。

#### 2.9 **24V电源接口**：

- ![image-20231027221148288](https://nickaljy-pictures.oss-cn-hangzhou.aliyuncs.com/image-20231027221148288.png)
- 作为整个开发板的电源输入接口。
  - ![image-20231029120526599](https://nickaljy-pictures.oss-cn-hangzhou.aliyuncs.com/image-20231029120526599.png)
    - 电源**并联**了一个**28V TVS管**，防止**瞬态高电压**烧坏开发板(**>28V视为高电压**)。
    - **Q2**是**NMOS**，用来防止**电源反接**对开发板造成损害。
    - **Q1**是**PMOS**，用来防止**电源接头接触瞬间打火**，造成接头损坏。


#### 2.10 **自定义按键**：

- ![image-20231027221307844](https://nickaljy-pictures.oss-cn-hangzhou.aliyuncs.com/image-20231027221307844.png)
- **板标13**是用户自定义按键，带有硬件**消抖**(:camel:)：
  - ![image-20231027222031791](https://nickaljy-pictures.oss-cn-hangzhou.aliyuncs.com/image-20231027222031791.png)
  - 当按键按下的时候，**PB2**检测到**高电平**；当按键松开的时候，**PB2**检测到**低电平**。
    - 前提：初始化的时候将**PB2下拉**。

#### 2.11 **复位按键：**

- ![image-20231027222354916](https://nickaljy-pictures.oss-cn-hangzhou.aliyuncs.com/image-20231027222354916.png)
- 按下按键产生**复位**。
- ![image-20231028142104527](https://nickaljy-pictures.oss-cn-hangzhou.aliyuncs.com/image-20231028142104527.png)
- VCC_3V3_S是直流电源，我们简化一下该电路：
  - <img src="https://nickaljy-pictures.oss-cn-hangzhou.aliyuncs.com/image-20231029213248931.png" alt="image-20231029213248931" style="zoom:50%;" />
  - 当**按键没有按下**的时候，**10K电阻**和**1uF电容**串联，当**电容充满电**的时候，相当于一个**无穷大**的**电阻**，此时电容分压接近于**VCC_3V3**，因此**NRST**此时输出**高电平**。
  - 当**按键按下**的时候，**1uF**的电容被**旁路**掉，此时回路中只**串联**一个**10K电阻**，**NRST**相当于**接地**(开关闭合相当于**导线**，**VCC_3V3**全部被**10K电阻**分压)。


#### 2.12 **外接晶振**：

- ![image-20231028125931727](https://nickaljy-pictures.oss-cn-hangzhou.aliyuncs.com/image-20231028125931727.png)
- **晶振(oscillator)**的**谐振频率**是**12MHz**：
  - 上图所示的晶振是**无源晶振**。
  - **晶振**的**2/4**引脚接**GND**。
  - **晶振**的**1/3**引脚(真正的晶振的两侧)接单片机的两个**OSC引脚**。
    - ![image-20231028133519160](https://nickaljy-pictures.oss-cn-hangzhou.aliyuncs.com/image-20231028133519160.png)
    - 晶振拥有一个重要参数：**负载容值**
      - 在晶振两端接两个电容(电容要**接地**)，这两个电容叫做"**负载电容**"，负载电容**并联**后的**等效电容值**等于或接近于**负载容值**的时候，满足晶振的起振要求，晶振正常工作。
        - 通常来讲，这两个电容设置为**22pF**比较合适。
    - **晶振并联电阻**：
      - 电阻作用：**反馈电阻**，方便晶振起振，电阻的阻值通常设置为**1MΩ**。

#### 2.13 **芯片电源系统**：

- ![image-20231028143338388](https://nickaljy-pictures.oss-cn-hangzhou.aliyuncs.com/image-20231028143338388.png)
- **VBAT**：直接接**VCC_3V3_MCU**芯片电源输入。
- **VREF+**：外接两个**并联电容**进行**滤波**(电容接地)，**1uF**对**低频信号**进行滤波，**100nF**对**高频信号**进行滤波。
- **VREF-**：直接**接地**。
- **VDD1 ~ 14**：**VCC_3V3_MCU**经过下面的**滤波电容**之后，输入到**VDD**引脚。
- **VDDA**：**模拟正电压**，**VCC_3V3_MCU**经过滤波电容之后，输入**VDDA**引脚。
- **VSSA**：**模拟负电压**，直接**接地**。

#### 2.14 **芯片启动电路：**

- **STM32的Boot configuration**：

  - 对于**STM32F4xx**来讲，有**三种**启动方式：
  - ![image-20231028153721817](https://nickaljy-pictures.oss-cn-hangzhou.aliyuncs.com/image-20231028153721817.png)
    - 当**BOOT0**为**低电平**的时候，**STM32**从**主闪存区**启动。
    - 当**BOOT1**为**低电平**，**BOOT0**为**高电平**的时候，**STM32**从**系统存储区**启动。

    - 当**BOOT1**为**高电平**，**BOOT0**为**高电平**的时候，**STM32**从**外部存储器**启动。

  - **STM32**复位后，**SYSCLK**(**系统时钟**)的**第四个上升沿**将锁存**BOOT**引脚上面的值(即第四个时钟上升沿对BOOT进行采样)，其中**BOOT0**是专用引脚，而**BOOT1**则与**GPIO**引脚共享，对于**STM32F4xx**来讲，**BOOT1**与**PB2**相连，当**SYSCLK**对**BOOT1**完成采样后，相应的**GPIO**引脚就会空出来。
  - 同样，**STM32**退出**待机模式(standby mode)**时，**SYSCLK**也会对**BOOT**进行重新采样，当**启动延时(startup delay)**结束后，**CPU**会从**0x0000 0000**处拿出栈顶值，然后从**0x0000 0004**开始，从**BOOT**所指定的**引导存储器**执行代码。

- ![image-20231029110810949](https://nickaljy-pictures.oss-cn-hangzhou.aliyuncs.com/image-20231029110810949.png)

  - 注意，上图的**NC**表示**开触电**，因此对于**BOOT**引脚来说，默认被**拉低**，其中**R1**和**R17**在电路板上是**空贴**，**焊点裸露**，当用镊子将**R1/R17短路**时，**BOOT**被**VCC_3V3_MCU**拉高。
    - 通常来讲，设计**STM32**启动电路的时候，应该使用**跳线**来选择**BOOT**的值。


#### 2.15 调压器电路：

- **嵌入式线性调压器**为**备份域**和**待机电路**以外的所有**数字电路**供电，调压器输出电压约为 1.2 V 。
- 调压器需要将**两个外部电容**(对于STM32F4xx来讲，连接两个2.2uF的电容接地)连接到专用引脚**VCAP_1**和**VCAP_2**，所有封装都配有这两个引脚。
  - ![image-20231029113612476](https://nickaljy-pictures.oss-cn-hangzhou.aliyuncs.com/image-20231029113612476.png)

#### 2.16 蜂鸣器：

- ![image-20231029122623418](https://nickaljy-pictures.oss-cn-hangzhou.aliyuncs.com/image-20231029122623418.png)
- 蜂鸣器使用**5V**供电，通过**PWM**控制。

#### 2.17 IMU模块：

- **IMU模块**由**MPU6600陀螺仪**和**IST8310地磁传感器**组成。

  - **IMU(Inertial Motion Unit)**，**惯性运动单元**，用来检测**加速度**和**角速度**。
  - [IMU Sensors: Everything You Need To Know! (embeddedinventor.com)](https://embeddedinventor.com/what-is-an-imu-sensor-a-complete-guide-for-beginners/)

- **MPU6600陀螺仪**：

  - ![image-20231029123356103](https://nickaljy-pictures.oss-cn-hangzhou.aliyuncs.com/image-20231029123356103.png)

  - 使用**SPI协议**通信。

- **IST8310地磁传感器**：

  - ![image-20231029125128931](https://nickaljy-pictures.oss-cn-hangzhou.aliyuncs.com/image-20231029125128931.png)

- **陀螺仪**会产生**温漂**的问题，因此在**MPU6600**旁边部署了**加热电路**：

  - ![image-20231029130213994](https://nickaljy-pictures.oss-cn-hangzhou.aliyuncs.com/image-20231029130213994.png)

  - 通过**PB5**引脚输出**PWM**控制电压，控制**10**颗**加热电阻**，通过**MPU6600**内部的**温度传感器**可以实现**温度闭环**，从而实现**恒温处理**。
    - **加热电阻**的工作电压是**24V**，可以在**1s**内将**IMU**模块从**25°C**加热到**50°C**。

- **地磁传感器**通过**IIC通信**，通信地址为**0x0E**。

- **IMU模块**为减少**电源噪声**的影响，采用独立的**LDO供电**：

  - ![image-20231029131044773](https://nickaljy-pictures.oss-cn-hangzhou.aliyuncs.com/image-20231029131044773.png)

#### 2.18 DBUS：

- DBUS协议是DJI遥控器的通用协议。
- ![image-20231029181427137](https://nickaljy-pictures.oss-cn-hangzhou.aliyuncs.com/image-20231029181427137.png)
- **DBUS接口**的**P3**与**USART1_RX**相连，但值得注意的是连接电路中做了一些**"手脚"**。
  - 当**P3**输入**低电平**的时候，晶体管**截止**，此时**USART_RX**输出**VCC_3V3_S**的电压值，即**高电平**。
  - 当**P3**输入**高电平**的时候，晶体管**导通**，此时我们计算一下$U_{be}$和$U_{ce}$，以次来判断**晶体管**的工作状态：
    - **输入回路**：
      - $3.3V = I_{B} * 4.7K + U_{be}$
    - **输出回路**：
      - $3.3V = Ic * 4.7K + U_{ce}$
    - 当晶体管工作在**放大区**/**饱和区**的时候，$I_B < I_C$，因此$U_{be} > U_{ce}$，因此晶体管工作在**饱和区**，通过晶体管的**输出特性曲线**可知，$U_{ce}$近似0，即USART_RX输出为**低电平**。
