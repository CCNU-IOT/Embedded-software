# 定时器：

作者：嵌入式软件:pen:

## 1.基本定时器：

#### 1.1 STM32F103ZET6：

- 该型号的单片机拥有两个**基本定时器**：**TIM6、TIM7**

#### 1.2 基本定时器介绍：

- 基本定时器的**功能有限**，不与**外部IO口**连接，只能用在**计数模式**。

- 基本定时器**组成**：
  - **16位自动重装载计数器**
  - **16位可编程预分频器**
    - 分频系数：**1～65536**，当该寄存器中的值为0时，表示分频系数为1。
  
- 基本定时器的**时基单元**：
  - **预分频寄存器(TIMx_PSC)**：
    - 若想驱动STM32中的定时器，那么需要给定时器输入**时钟信号**(时钟信号是数字电路的**心脏**:heart:)。
    - 预分频寄存器的作用：**改变输入时钟的频率，输出一个与输入时钟信号频率不同的时钟信号**。
      - 输出的时钟信号就是负责定时器**计数**的时钟，因此**预分频器**能够改变定时器的**计数速度**。
    - **定时器的输入时钟**：
      - 基本定时器的时钟源：**CK_INT**，即**内部时钟**。
        - 然而，这个**内部时钟**到底指什么呢？
          - 不是指**HSI**(高速内部时钟)和**LSI**(低速内部时钟)
          - **CK_INT—内部时钟**指的是：**基本定时器内部所挂载总线的时钟**:heavy_check_mark:。
        - 基本定时器挂载在**APB1总线**上：
          - ![image-20231001214447162](https://nickaljy-pictures.oss-cn-hangzhou.aliyuncs.com/image-20231001214447162.png)
        - 参考**STM32F103的时钟树**:deciduous_tree:：
      - <img src="https://nickaljy-pictures.oss-cn-hangzhou.aliyuncs.com/image-20231001213359408.png" alt="image-20231001213359408" style="zoom: 67%;" />
      - 挂载在**APB1总线**上面的**peripheral**时钟频率是**36MHz**。
      - 挂载在**APB1总线**上面的**Timer**的时钟频率是**72MHz**。
    - 假设**TIMx_PSC**中的值是**71**，那么**预分频系数**是**72**，此时输入到基本定时器中的时钟频率是**72MHz/72 = 1MHz**。
  - **计数器寄存器(TIMx_CNT)**与**自动重装载寄存器(TIMx_ARR)**：
    - 对于STM32的基本定时器来讲，只有一种计数模式：**递增计数**。
    - 计数器从0**累加计数**到**自动重装载数值**，产生一个**计数器溢出事件**(这里我们称为定时器上溢)，然后重新从0开始计数。
    - **计数器溢出事件**：
      - 对于基本定时器来讲，这个溢出事件通常是**产生更新中断**(通俗点理解为中断)。
      - 除了产生中断信号之外，我们还可以配置基本定时器的溢出事件为：**产生DMA请求**和**触发DAC同步电路**
  
- 基本定时器的**驱动代码**(HAL):pick:：
  - 所用到的HAL库：**stm32f1xx_hal_tim.c、stm32f1xx_hal_tim_ex.c**
  
  - **第一步：创建定时器句柄**
  
    - ```c
      ***************************/*定时器句柄结构体定义*/*******************************
      typedef struct
      {
      	TIM_TypeDef *Instance; /* 外设寄存器基地址 */
      	TIM_Base_InitTypeDef Init; /* 定时器初始化结构体*/
      	HAL_TIM_ActiveChannel Channel; /* 定时器通道 */
      	DMA_HandleTypeDef *hdma[7]; /* DMA 管理结构体 */
      	HAL_LockTypeDef Lock; /* 锁定资源 */
      	__IO HAL_TIM_StateTypeDef State; /* 定时器状态 */
      }TIM_HandleTypeDef;
      //定义结构体：
      TIM_HandleTypeDef base_time_handle;//通常将其声明在全局区
      ***************************/*外设寄存器基地址*/***********************************
      //外设寄存器的基地址封装在头文件xxx中，某一个外设的所有寄存器地址是连续的，以TIM6为例
      base_time_handle.Instance = TIM6
      ***************************/*定时器初始化结构体定义*/******************************
      typedef struct 
      {
      	uint32_t Prescaler; /* 预分频系数 */
      	uint32_t CounterMode; /* 计数模式 */
      	uint32_t Period; /* 自动重载值 ARR */
      	uint32_t ClockDivision; /* 时钟分频因子 */
      	uint32_t RepetitionCounter; /* 重复计数器 */
      	uint32_t AutoReloadPreload; /* 自动重载预装载使能 */
      }TIM_Base_InitTypeDef;
      //Prescaler:写入预分频寄存器的值
      //——————范围是0 ~ 65535，表示的预分频系数为1 ~ 65536
      //CounterMode:计数器的计数模式
      //——————基本定时器只有一种计数模式，向上计数，CounterMode = TIM_COUNTERMODE_UP
      //Period:自动重装载寄存器的值
      //——————基本定时器的计数上限，Period的英文是时间，取值是0 ~ 65535
      //ClockDivision和RepetitionCounter:
      //——————基本定时器中没有这两个功能，因此不需要考虑这两个参数
      //AutoReloadPreload:预装载使能
      //——————使能后，重装载寄存器有缓冲，只有在更新事件发生时才会把重装载的值写入其影子寄存器。
      //——————失能后，重装载寄存器没有缓冲，那么修改自动重载寄存器的值时，该值会马上被写入其影子寄存器中。
      //------默认使能。
      ******************************/*定时器通道选择*/*********************************
      //基本定时器没有通道功能，因此基本定时器没有相关联的IO口。
      //对于基本定时器，不需要配置该参数。
      *********************************/*其它参数*/***********************************
      //暂且不需要配置
      ```
  
  - **第二步：初始化定时器**
  
    - ```c
      ******************************/*调用定时器初始化函数*/****************************
      HAL_TIM_Base_Init(&base_time_handle);//接受句柄结构体指针
      ```
  
  - **第三步：重写定时器底层驱动函数**
  
    - `void HAL_TIM_Base_MspInit(TIM_HandleTypeDef *htim)`
  
      - 该函数是定时器配置的底层函数，该函数会被`HAL_TIM_Base_Init`函数在**最后**调用。
      - 底层驱动函数中通常放置**GPIO**、**NVIC**、**时钟**相关代码。
      - 该函数是**_weak**函数，因此可以进行**重写**。
  
    - ```c
      *****************************/*重写定时器底层驱动函数*/****************************
      void HAL_TIM_Base_MspInit(TIM_HandleTypeDef *htim)
      {
      	if (htim->Instance == TIM6)//该函数是公共函数，因此要对定时器进行判断
      	{
      		__HAL_RCC_TIMx_CLK_ENABLE(); /*x=1~8，使能TIMx时钟*/
      		HAL_NVIC_EnableIRQ(TIM6_DAC_IRQn); /*开启TIMx中断，函数有什么用？*/
              HAL_TIM_Base_Start_IT(&base_time_handle); /*使能定时器x和定时器x更新中断*/
      	}
      }
      ```
  
  - **第四步：定义定时器中断服务函数**
  
    - 在**.s的汇编文件**中，定义了所有外部中断的**入口**，对于**基本定时器TIM6**来说，中断入口：`TIM6_DAC_IRQHandler`，通常，我们可以使用**宏定义重写函数名**。
  
    - ```c
      void TIM6_DAC_IRQHandler(void)//中断入口函数
      {
          HAL_TIM_IRQHandler(&base_time_handle);
          //调用函数为定时器的"公共中断服务函数"。
      }
      ```
  
  - **第五步：重写中断回调函数**
  
    - 公共中断函数会根据**具体的中断标志**来选择**执行回调函数**。
  
    - 上述代码中，设置的**溢出事件**是**开启更新中断**，因此要**重写更新中断回调函数**。
  
    - ```c
      void HAL_TIM_PeriodElapsedCallback(TIM_HandleTypeDef *htim)
      {
      	if (htim->Instance == TIM6)
      	{
      		/*用户代码：中断逻辑*/
      	}
      }
      ```


## 2.通用定时器：

#### 1.1 STM32F103ZET6：

- 该型号的单片机拥有四个**通用定时器**：**TIM2、TIM3、TIM4、TIM5**

#### 1.2 通用定时器介绍：

- 通用定时器可以理解为基本定时器的**升级版**，功能更多，并且通过**通道**的方式和**外部IO**相连接。
- 通用定时器的**时基单元**：
  - **预分频寄存器 (TIMx_PSC)**：
    - 通用定时器的预分频寄存器和基本定时器的相同，都是**16位**，取值是**0 ~65535**，分频系数是**1 ~ 65536**。
    - 预分频系数是针对定时器的输入时钟进行分频的参数，当通用定时器的输入时钟是**内部时钟CK_INT**时，通用定时器和基本定时器相同，由于通用定时器也挂载在**APB1总线**上，因此**CK_INT**时钟的频率是**72MHz**。
  - **计数器寄存器(TIMx_CNT)**与**自动重装载寄存器(TIMx_ARR)**：
    - 对于通用定时器，有**三种**计数模式：**向上计数**、**向下计数**、**中央对齐计数**。
      - **向上计数**：
        - 计数器从0**向上累加**计数到**自动重装载值**(TIMx_ARR寄存器的值)，产生一个**计数器溢出事件**(定时器上溢)，然后重新从0开始计数。
      - **向下计数：**
        - 计数器从**自动重装载值**(TIMx_ARR寄存器的值)**向下递减**到0，产生一个**计数器溢出事件**(定时器下溢)，然后重新从自动重装载值开始计数。
      - **中央对齐计数**：
        - 中央对齐计数可以理解为"**先向上计数，再向下计数**"。
        - 计数器从0开始**递增计数**到**自动重装载值−1**，产生一个**计数器溢出事件**(定时器上溢)，然后**递减计数**到**1**并且产生一个**计数器溢出事件**(定时器下溢)，循环上述过程。
        - 中央对齐计数最大的特点是：**即能够产生定时器上溢，也能够产生定时器下溢**。
          - 溢出值和**向上计数/向下计数**略有不同，相比之下**少1**。
- 通用定时器的**时钟源**：
  - **CK_INT—内部时钟**:bird:：
    - 由于**通用定时器**挂载在**APB1总线**上，因此**CK_INT**的时钟频率是**72MHz**。
    - 使用**CK_INT**作为时钟源的时候，定时器通常处于**计数模式**。

  - **TIx—外部时钟源**:scream_cat:：
    - 通用定时器的**通道**：
      - 对于通用定时器来讲，每个定时器都有**四个内部通道**：
        - `TIMx_CH1`、`TIMx_CH2`、`TIMx_CH3`、`TIMx_CH4`

      - 每个通道和一个**IO口连接**，以**STM32F103ZET6的TIM4**为例：
        - ![image-20231003103542185](https://nickaljy-pictures.oss-cn-hangzhou.aliyuncs.com/image-20231003103542185.png)
        - **TIM4_CH1   <---->   PB6**
        - **TIM4_CH2   <---->   PB7**
        - **TIM4_CH3   <---->   PB8**
        - **TIM4_CH4   <---->   PB9**

    - **外部时钟源模式1**：
      - 当定时器的输入时钟是**TIx—外部时钟源**的时候，处于**外部时钟源模式1**。
      - 之前接触**51**的时候，定时器可以对**外部信号**(**上升沿**或者**下降沿**)进行计数，在**STM32**中，**外部时钟源模式1**执行了类似的功能。
      - **外部时钟源模式1**工作流程：
        - 定时器的通道作为外部信号的输入端，配置定时器检测外部信号的上升沿/下降沿，当检测到上升沿/下降沿，计数器计数一次。
          - 通用定时器只有**通道1**和**通道2**可以作为外部信号的输入端。

  - **ETR—外部时钟源**:dog2: ：
    -  **ETR**是**外部触发输入**，此时定时器处于**外部时钟源模式2**：
      - 该模式和**外部时钟源模式1**类似，都是对外部信号的**上升沿/下降沿**进行计数，不同点：
        - **模式1**对定时器的**通道1/通道2**的输入信号进行计数。
        - **模式2**对定时器的**ETR**引脚的输入信号进行计数。

      - 每个通用定时器都有一个**ETR**引脚，这里以**STM32F103ZET6**的**TIM4**为例：
        - ![image-20231003105826111](https://nickaljy-pictures.oss-cn-hangzhou.aliyuncs.com/image-20231003105826111.png)

- **输入捕获**：
  - 通俗点来讲，能够对输入信号的**上升沿/下降沿**进行捕获，在上升沿/下降沿到来的时候，将当前**定时器**的值(**TIMx_CNT**)存放到对应的**捕获/比较寄存器**(**TIMx_CCRx**)里面，完成一次捕获，并产生一次**捕获事件**(称为**捕获溢出**)。
    - 捕获事件可以是**中断**或**DMA**。
    - 输入捕获可以捕获边沿时间，因此输入捕获可以用来**测量脉冲宽度或者测量频率**。

  - **PWM输入捕获**：
    - **PWM输入捕获**能够对**PWM信号**进行捕获操作，进而通过**捕获/比较寄存器**的值求出**PWM信号**的**周期**和**占空比**。

- **输出比较**：
  - **输出比较**是把通用定时器的**通道**作为**输出端口**，由于通用定时器有四个通道，因此在该模式下，定时器有**四个输出端口**。
  - **输出比较**用来输出**PWM信号**。
    - 对于输出比较来讲，每一路通道的**PWM信号频率**可以不同。

  - PWM模式：
    - **PWM模式**是输出比较的一个特例，同样是用来输出**PWM信号**，和输出比较不同的是，**PWM模式**每一路通道生成的**PWM信号频率**相同，但是**占空比**可以不同。


## 3.高级定时器：

#### 1.1 STM32F103ZET6：

- 该型号的单片机拥有两个**高级定时器**：**TIM1、TIM8**

#### 1.3 高级定时器介绍：

- 高级定时器相较于通用定时器最大的作用：**输出嵌入死区时间的互补PWM**
- 高级定时器的**时基单元**：
  - 待补充......